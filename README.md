# RIMD-DLAC-SPECT-MPI

End-to-end pipeline for SPECT attenuation correction (AC) with training, multi-input inference, and ensemble ATM → MAC reconstruction.

## Repository Structure
- `train.py` – training entry point
- `inference_external.py` – legacy inference/evaluation utilities
- `inference_test.py` – production inference pipeline (multi-input + ensemble + NAC/ATM/MAC saving)
- `evaluate.py` – metrics and model evaluation helpers
- `utils.py` – shared transforms and IO helpers (`get_post_transforms_ac`, `apply_post_transforms_ac`, `spect_ac_recon`)
- `requirements.txt` – pinned runtime dependencies

## Environment
- Python packages are pinned in `requirements.txt`.
- Install with:
```bash
pip install -r requirements.txt
```

## Data Expectations
- Input NM raw directory contains scanner raw files (per study/exam). Example:
```
/path/to/NM/
  ├── StudyA/...
  ├── StudyB/...
  └── ...
```

## Output Structure
`inference_test.py` creates:
```
output_dir/exp_name/
├── NM/                    # Copied NM raw files
├── NAC/                   # NAC reconstructions (NIfTI)
│   ├── OSEM_4I4S/
│   ├── OSEM_6I6S/
│   └── OSEM_8I8S/
├── ATM_predictions/       # Individual model ATM predictions (one folder per model)
├── ATM_ensemble/          # Ensemble ATM predictions (averaged)
└── MAC/                   # Final AC reconstructions (NIfTI)
    ├── OSEM_4I4S/
    ├── OSEM_6I6S/
    └── OSEM_8I8S/
```

## Inference (Multi-Input + Ensemble)
- Multi-input only (3 channels: OSEM_4I4S, OSEM_6I6S, OSEM_8I8S).
- ATM predictions are generated by all models in `--model_dir`, ensembled, and individual model folders are removed after ensembling.
- NAC is saved via DICOM using pytomography’s writer, converted to NIfTI with SimpleITK, then interim DICOM files are deleted.
- All ATM/MAC/NAC saving uses `utils.get_post_transforms_ac` to preserve metadata.

Run:
```bash
python inference_test.py \
  --nm_raw_dir /path/to/NM \
  --output_dir /path/to/output \
  --exp_name my_experiment \
  --model_dir /path/to/models_dir \
  --colimator SY-LEHR \
  --num_workers 4
```

Notes:
- Place your trained `.pt` files in `--model_dir` (ensemble expects multiple).
- The pipeline:
  1) NM → NAC (OSEM 4/6/8) with DICOM save → NIfTI convert → DICOM cleanup
  2) NAC → ATM predictions (per model) → ATM ensemble (average) → per-model folders removed
  3) ATM ensemble + NM raw → MAC reconstructions (OSEM 4/6/8)

## Training
Example (adjust paths/flags per your setup):
```bash
python train.py \
  --data_path_train /path/to/train/NIfTI \
  --exp_dir /path/to/output \
  --exp my_train_run \
  --input_type OSEM_8I8S \
  --num_input 1
```

## Evaluation Utilities
`evaluate.py` provides SSIM, PSNR, MAE/NMAE/NMSE helpers and “best model” selection utilities.

## Key Implementation Details
- NAC save: DICOM via pytomography (`save_dcm`), then converted to NIfTI with SimpleITK; DICOM temp folders removed.
- Ensemble: `get_ac_images_from_models` → `ensemble_image_regression` → averaged ATM in `ATM_ensemble`, model folders removed post-ensemble.
- Saving: `utils.get_post_transforms_ac` and `apply_post_transforms_ac` ensure metadata and orientation are preserved.

## Troubleshooting
- Empty `ATM_ensemble`: ensure `--model_dir` contains `.pt` files and individual model predictions are produced.
- CUDA/driver mismatch: verify CUDA 12.x libs match your PyTorch build.
- DICOM conversion: ensure SimpleITK is installed and files are valid DICOM.

## License
Based on MONAI; Apache 2.0 License.